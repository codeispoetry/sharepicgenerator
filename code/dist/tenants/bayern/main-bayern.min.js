const draw=SVG().addTo("#canvas");var info={foo:null};const bgpic={width:800,height:450,originalWidth:1920,originalHeight:1080,filename:"../assets/bg_small.jpg"},secondaryfont={family:"ArvoGruen",size:15,anchor:"left",weight:700};function message(e=!1){e?$("#message").show().html(e):$("#message").hide()}function redrawCockpit(){config.video?$(".novideo").addClass("d-none"):$(".novideo").removeClass("d-none")}function showMosaicLines(){for(i=1;i<=2;i++)$("#canvas").append('<div class="gridline horizontal mosaicline" style="top:'+100*i/3+'%;"></div>'),$("#canvas").append('<div class="gridline vertical mosaicline" style="top:0;left:'+100*i/3+'%;"></div>')}function deleteMosaicLines(){$(".mosaicline").remove()}function closeOverlay(){Math.max(document.documentElement.clientWidth,window.innerWidth||0);$('head meta[name="viewport"]').attr("content","width=800, initial-scale=0.4"),$(".overlay.active").removeClass("active")}function setDrawsize(){let e=$("#width").val(),i=$("#height").val(),a=e/i;for(config.socialmediaplatform="",e>800&&(i=(e=800)/a);i>800;)i=(e-=50)/a;draw.size(e,i),$("#canvas").width(draw.width()),$("#canvas").height(draw.height()),calculateSizes(),text.bounce(),pin.bounce(),window.setTimeout(logo.draw,100),window.setTimeout(copyright.draw,200),window.setTimeout(copyright.draw,300)}function resetDrawsize(){$("#width").val(info.originalWidth),$("#height").val(info.originalHeight),$("#sizepresets").val($("#sizepresets option:first").val()),setDrawsize()}function setDimensions(e,i){$("#width").val(e),$("#height").val(i),setDrawsize()}function calculateSizes(){$("#textsize").attr("min",.1*draw.width()),$("#textsize").attr("max",draw.width()),$("#textsize").val(.3*draw.width()),$("#textX").val(0),$("#textY").val(draw.height()/5),$("#pinX").val(.7*draw.width()),$("#pinY").val(.5*draw.height()),$("#backgroundsize").attr("min",draw.width()),$("#backgroundsize").attr("max",5*draw.width()),$("#backgroundsize").val(draw.width()),$("#backgroundX").val(0),$("#backgroundY").val(0),reset()}function getEncodingStatus(){$.ajax({url:"../getvideoencodestatus.php?videofile="+config.videofile,type:"GET",dataType:"JSON",success:function(e){let i=Math.round(100*e.currentposition/config.videoduration);$("#download").html(i+"% des Videos sind schon fertig. Bitte warten.")}})}function uploadFileByUrl(e,i=function(){}){$("#waiting").addClass("active");let a=new FormData;client=new XMLHttpRequest,a.append("id","uploadbyurl"),a.append("url2copy",e),client.onerror=function(e){console.log("onError",e)},client.upload.onprogress=function(e){let i=Math.round(100/e.total*e.loaded);$("#uploadpercentage").html(i),i>99&&$("#uploadstatus").html("Dein Bild wird verarbeitet...")},client.onload=function(e){let a=JSON.parse(e.target.response);closeOverlay(),a.error&&console.log(a),config.filename=a.filename,config.video=1==a.video,1==a.video&&(config.videofile=a.videofile,config.filename=a.filename,config.videoduration=a.videoduration,$("#width").val(a.originalWidth),$("#height").val(a.originalHeight)),redrawCockpit(),afterUpload(a),i()},client.open("POST","../upload.php"),client.send(a)}function afterUpload(e){draw.size(e.width,e.height),info.originalWidth=e.originalWidth,info.originalHeight=e.originalHeight,info.previewWidth=draw.width(),info.previewHeight=draw.height(),$("#backgroundURL").val(e.filename),$("#width").val(e.originalWidth),$("#height").val(e.originalHeight),$("#fullBackgroundName").val(e.fullBackgroundName),setDrawsize(),$("#sizepresets").val($("#sizepresets option:first").val()),background.draw()}$(document).ready(function(){$("#width").val(bgpic.originalWidth),$("#height").val(bgpic.originalHeight),pin.draw(),window.setTimeout(text.draw,10),afterUpload(bgpic),window.setTimeout(load,1e3),$("[data-click]").click(function(){window[$(this).data("click")]()})}),$("#color-scheme").bind("change",function(){$("body").toggleClass("dark")}),$("#gridlines").bind("change",function(){$(".gridline").toggleClass("d-none")}),$(".close").click(closeOverlay),closeOverlay(),$(".size").bind("input propertychange",setDrawsize),$("#sizereset").click(resetDrawsize),$("#sizepresets").on("change",function(){setDimensions(...this.value.split(":")),config.socialmediaplatform=$("#sizepresets option:selected").data("socialmediaplatform"),config.isMosaic=-1!=config.socialmediaplatform.search(/Mosaik/g),deleteMosaicLines(),config.isMosaic&&showMosaicLines(),background.resize()}),$(".size").bind("input propertychange",function(){$("#sizepresets").val($("#sizepresets option:first").val())}),$(".choose-mosaic").bind("click",function(){$("#sizepresets").val("2400:2400").trigger("change")}),$("#download").click(function(){$(this).prop("disabled",!0);let e,i=$(this).html();config.video?($(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Das Video wird erstellt ...</span>'),window.setTimeout(function(){e=window.setInterval(function(){getEncodingStatus()},3e3)},3e3)):$(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Augenblick bitte'),$("#canvas").addClass("opacity");let a="jpg";1==config.video&&(a="mp4",background.svg.hide());let t=draw.svg();1==config.video&&background.svg.show(),$.ajax({type:"POST",url:"../createpic.php",data:{svg:t,format:a,usepixabay:config.usePixabay,ismosaic:config.isMosaic,socialmediaplatform:config.socialmediaplatform,videofile:config.videofile,width:$("#width").val()},success:function(t,o,n){let r=JSON.parse(t);$("#download").prop("disabled",!1),$("#canvas").removeClass("opacity"),$("#download").html(i),window.clearInterval(e);let s=$("#text").val().toLowerCase();s=(s=(s=(s=(s=(s=s.replace(/[ä|ö|ü|ß]/g,function(e){switch(e){case"ä":return"ae";case"ö":return"oe";case"ü":return"ue";case"ß":return"ss"}})).replace(/[^a-zA-Z0-9]/g,"-")).replace(/\-+/g,"-")).replace(/^\-/g,"")).replace(/\-$/g,"")).substring(0,20),config.socialmediaplatform&&(s=s.substring(0,14)+"-"+config.socialmediaplatform.toLowerCase()),config.isMosaic&&(a="zip"),window.location.href="../download.php?file="+r.basename+"&format="+a+"&downloadname="+s}})}),$(".upload-file").change(function(e){let i=$(this).attr("id"),a=document.getElementById(i).files[0];if(document.getElementById(i).files[0].size/1024/1024>100)return alert("Die Datei ist zu groß. Es sind maximal 100 MB erlaubt.\n\nSchicke Dir die Datei per z.B. WhatsApp zu, dann wird sie automatisch verkleinert. Mehr als 20 MB pro Minute Video braucht es nicht."),!1;$("#waiting").addClass("active"),$(this).prop("disabled",!0);let t=new FormData;client=new XMLHttpRequest,a&&(t.append("file",a),t.append("id",i),t.append("user",config.user),t.append("accesstoken",config.accesstoken),client.onerror=function(e){console.log("onError",e)},client.onload=function(e){let a=JSON.parse(e.target.response);if($("#"+i).prop("disabled",!1),$("#waiting").removeClass("active"),a.error)return console.log(a.error),!1;switch(config.video=1==a.video,1==a.video&&(config.videofile=a.videofile,config.filename=a.filename,config.videoduration=a.videoduration,$("#width").val(a.originalWidth),$("#height").val(a.originalHeight)),redrawCockpit(),i){case"uploadfile":afterUpload(a);break;case"uploadlogo":$("#logoselect").val("custom"),logo.load();break;case"uploadicon":$("#iconfile").val(a.iconfile),icon.load(),$(".iconsizeselectwrapper").removeClass("d-none");break;default:console.log("error in upload",a)}},client.upload.onprogress=function(e){let i=Math.round(100/e.total*e.loaded);$("#uploadpercentage").html(i)},client.onabort=function(e){console.log("Upload abgebrochen")},client.open("POST","../upload.php"),client.send(t))}),$(".uploadfileclicker").click(function(){$("#uploadfile").click()}),$(".uploadlogoclicker").click(function(){$("#uploadlogo").click()}),$(".uploadiconclicker").click(function(){$("#uploadicon").click()});const background={svg:draw.circle(0),darklightlayer:draw.circle(0),greenlayer:draw.circle(0),isLoaded:!1,draw(){this.svg.remove();let e=$("#backgroundURL").val();this.svg=draw.image(e,function(e){this.back().draggable(),background.isLoaded=!0,background.resize(),background.addFilter(),background.svg.move(parseInt($("#backgroundX").val()),parseInt($("#backgroundY").val())),this.on("dragend.namespace",function(e){$("#backgroundX").val(Math.round(this.x())),$("#backgroundY").val(Math.round(this.y())),background.uncoveredAreaWarning()}),this.draggable().on("beforedrag",e=>{background.svg.width()==draw.width()&&0==background.svg.x()&&background.svg.height()==draw.height()&&0==background.svg.y()&&e.preventDefault()}),background.addGreenLayer(),background.addDarkLightLayer()})},addGreenLayer:function(){this.greenlayer.remove();let e=$("#greenlayer").val()/100;this.greenlayer=draw.rect(draw.width(),draw.height()).fill("#46962b").opacity(e),this.greenlayer.attr("style"," pointer-events: none;"),this.darklightlayer.back(),this.greenlayer.back(),this.svg.back()},addDarkLightLayer:function(){this.darklightlayer.remove();let e=$("#darklightlayer").val()/100,i=e>0?"black":"white";e=Math.abs(e),this.darklightlayer=draw.rect(draw.width(),draw.height()).fill(i).opacity(e),this.darklightlayer.attr("style"," pointer-events: none;"),this.darklightlayer.back(),this.greenlayer.back(),this.svg.back()},addFilter:function(){this.svg.filterWith(function(e){e.colorMatrix("saturate",$("#graybackground").val()).gaussianBlur($("#blurbackground").val())})},reset:function(){$("#backgroundX").val(0),$("#backgroundY").val(0),$("#backgroundsize").val(parseInt($("#backgroundsize").prop("min"))),this.draw(),background.uncoveredAreaWarning()},resize:function(){let e=parseInt($("#backgroundsize").val());if(this.svg.size(e),background.hasRoundingError()){let e=parseInt($("#backgroundsize").val());$("#backgroundsize").val(e+=5),this.resize()}background.uncoveredAreaWarning()},hasRoundingError:function(){return draw.height()-background.svg.height()>0},uncoveredAreaWarning:function(){if(!this.isLoaded)return!1;let e=!1;switch($("#design").val()){case"bigright":this.svg.x()>0&&(e=!0),this.svg.y()>0&&(e=!0),this.svg.y()+this.svg.height()<draw.height()&&(e=!0);break;default:this.svg.x()>0&&(e=!0),this.svg.x()+this.svg.width()<draw.width()&&(e=!0),this.svg.y()>0&&(e=!0),this.svg.y()+this.svg.height()<draw.height()&&(e=!0)}e?message('Im Bild entsteht ein weißer Rand. Platziere das Bild neu, <u class="cursor-pointer" onClick="background.reset();">setze es zurück</u> oder vergrößere es.'):message()}};function save(){let e=$("#pic").serialize();$.post("../save.php",{user:config.user,action:"save",data:e,accesstoken:config.accesstoken}).done(function(e){$("#load").removeClass("d-none"),$("#delete").removeClass("d-none"),$(".saving-response").html("Gespeichert.").delay(2e3).fadeOut()})}function unlink(){confirm("Zwischenspeicherung wirklich löschen?")&&$.post("../save.php",{user:config.user,action:"delete",accesstoken:config.accesstoken}).done(function(e){$(".saving-response").html("Gelöscht.").delay(2e3).fadeOut(),$("#load").addClass("d-none"),$("#delete").addClass("d-none")})}function load(){$.post("../get.php",{user:config.user,action:"getSavedPic",accesstoken:config.accesstoken}).done(function(e){let i=JSON.parse(e);if(!i.data)return!1;let a=JSON.parse(i.data);for(var t in $("#load").removeClass("d-none"),$("#delete").removeClass("d-none"),$("#width").val(a.width),$("#height").val(a.height),setDrawsize(),a)$("#"+t).val(a[t]);["textsamesize","greenbehindtext"].forEach(function(e){"on"===a[e]&&$("#"+e).prop("checked",!0)}),window.setTimeout(function(){text.draw(),logo.load(),background.draw(),copyright.draw(),pin.draw(),icon.load()},100),window.setTimeout(function(){copyright.draw(),pin.draw()},500)})}$("#backgroundreset").click(function(){background.reset()}),$("#backgroundsize").bind("input propertychange",function(){background.resize()}),$("#graybackground, #blurbackground").bind("input propertychange",function(){background.addFilter()}),$("#darklightlayer").bind("input propertychange",function(){background.addDarkLightLayer()}),$("#darklightlayer").dblclick(function(){$(this).val(0),background.addDarkLightLayer()}),$("#greenlayer").bind("input propertychange",function(){background.addGreenLayer()}),$("#copyright").bind("input propertychange",function(){copyright.draw()}),$(".copyright-change-color").click(function(){copyrightColorIndex++,copyrightColorIndex%=copyrightColors.length,copyright.draw()});let copyrights={};function setCopyright(e,i){copyrights[i]="pixabay"==i?"Foto: "+e+"@pixabay.com":"Icon: "+e,$("#copyright").val(Object.values(copyrights).join(", ")),copyright.draw()}var copyrightColors=["white","black","#46962b","#E6007E","#FEEE00"],copyrightColorIndex=0;const copyrightfont={family:"Arial",size:9,anchor:"left",weight:300},copyright={svg:draw.text(""),draw(){copyright.svg.remove(),copyright.svg=draw.text($("#copyright").val()).font(copyrightfont).fill(copyrightColors[copyrightColorIndex]).move(10,draw.height()-12).rotate(-90,copyright.svg.x(),copyright.svg.y())}};$("#pixabayopener").click(function(){$('head meta[name="viewport"]').attr("content","width=device-width, initial-scale=1"),$("#pixabay").addClass("active")}),$("#pixabay-form").submit(function(e){return e.preventDefault(),getPixabayImages($("#pixabay .q").val()),!1});var page=1;function getPixabayVideos(e){$("#videos-tab").tab("show"),$("#pixabay-videos .results").html('<div class="col-12">Suche Videos ...</div>');let i="https://pixabay.com/api/videos/?key="+config.pixabay.apikey+"&q="+encodeURIComponent(e)+"&page="+page+"&per_page=100";$.ajax({url:i,success:function(e,i,a){$("#pixabay-videos .results").html(""),e.hits.forEach(function(e){$("#pixabay-videos .results").append('<div class="col-12 col-md-3 video pb-4"><video controls><source src="'+e.videos.tiny.url+'" type="video/mp4"></video><button class="btn btn-outline-primary btn-sm" data-url="'+e.videos.small.url+'" data-user="'+e.user+'">verwenden</button></div>')}),$("#pixabay-videos .results button").click(function(){let e=$(this).data("user");uploadFileByUrl($(this).data("url"),function(){setCopyright(e,"pixabay"),config.usePixabay="pixabay"})})},error:function(e,i,a){console.log(e,a)}})}function getPixabayImages(e){let i="https://pixabay.com/api/?key="+config.pixabay.apikey+"&q="+encodeURIComponent(e)+"&image_type=photo&page="+page+"&per_page=100";$("#images-tab").tab("show"),$("#pixabay-images .results").html("Suche Bilder ... "),$.ajax({url:i,success:function(e,i,a){$("#pixabay-images .results").html(""),e.hits.forEach(function(e){$("#pixabay-images .results").append('<img src="'+e.previewURL+'" data-url="'+e.largeImageURL+'" data-user="'+e.user+'" class="img-fluid">')}),$("#pixabay-images .results>img").click(function(){let e=$(this).data("user");uploadFileByUrl($(this).data("url"),function(){setCopyright(e,"pixabay"),config.usePixabay="pixabay"})})},error:function(e,i,a){console.log(e,a)}})}$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(e.target,e.relatedTarget,"videos-tab"==$(e.target).attr("id")){if(""==$("#pixabay .q").val())return;getPixabayVideos($("#pixabay .q").val())}}),$("#templateopener").click(function(){$('head meta[name="viewport"]').attr("content","width=device-width, initial-scale=1"),$("#templates").addClass("active")}),$(".templatepic").click(function(){let e=$(this),i=$(this).data("attribution");uploadFileByUrl($(this).data("url"),function(){setCopyright(i,"");let a=e.data("text").replace(/@/g,"!").replace(/§/g,"\n");$("#text").val(a),$("#textX").val(e.data("x")),$("#textY").val(e.data("y")),$("#textsize").val(e.data("size"))})});